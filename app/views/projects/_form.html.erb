<%= error_messages_for 'project' %>

<div class="box tabular">
<!--[form:project]-->
<p><%= f.text_field :name, :required => true, :size => 60 %></p>
<% if action_name == 'settings' %>
  <p><%= f.select :status, options_for_select(Project::STATUS_MAP.map { |k, v| [v, k] }) %></p>
<% end %>
<p><%= f.text_area :description, :rows => 8, :class => 'wiki-edit' %></p>
<p>
  <% if @project.id.nil? && !@project.parent_id.nil? %>
    <% @parent = Project.where(id: @project.parent_id).first %>
    <% if !@parent.nil? %>
      <% new_identifier = "#{Project.where(parent_id: @project.parent_id).count + 1}" %>
      <% @project.identifier = "#{@parent.identifier}_#{new_identifier}" %>
    <% else %>
      <% new_identifier = "#{@project.parent_id}_#{Project.where(parent_id: @project.parent_id).count + 1}" %>
      <% @project.identifier = "hdbfs_#{new_identifier}" %>
    <% end %>
  <% else %>
    <% @project.identifier = "hdbfs_#{Project.where(parent_id: @project.parent_id).last.id + 1}" %>
  <% end %>

  <%= f.text_field :identifier, :required => true, :size => 60, :maxlength => Project::IDENTIFIER_MAX_LENGTH %>

  <% unless @project.identifier_frozen? %>
    <em class="info">
      <%= l(:text_length_between, :min => 1, :max => Project::IDENTIFIER_MAX_LENGTH) %>
      <%= l(:text_project_identifier_info).html_safe %>
    </em>
  <% end %>
</p>

<p>
  <%= f.check_box :is_public, :disabled => !@project.safe_attribute?(:is_public) %>
  <em class="info"><%= Setting.login_required? ? l(:text_project_is_public_non_member) : l(:text_project_is_public_anonymous) %></em>
</p>

<% unless @project.allowed_parents.compact.empty? %>
    <p><%= label(:project, :parent_id, l(:field_parent)) %><%= parent_project_select_tag(@project) %></p>
<% end %>

<% if @project.safe_attribute? 'inherit_members' %>
<p><%= f.check_box :inherit_members %></p>
<% end %>

<%= wikitoolbar_for 'project_description' %>

<% if !@project.id.nil? %>
<p>
  <label for="revised_end_date">Revised End Date</label>
  <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
  <input type="date" id="revised_end_date" name="revised_end_date" class="form-control">
  <button type="button" id="update-revised-end-date" class="btn btn-primary">Update</button>
</p>
<div class="row">
  <div class="col-md-6 offset-md-6">
    <% if @revised_end_date_history&.any? %>
      <div class="border p-3 mb-3 text-right">
        <h3 class="text-right">Revised End Date History</h3>
        <% @revised_end_date_history.each do |history| %>
          <div class="text-right">
            <%= history&.value&.to_date&.strftime("%d/%m/%Y") %>
          </div>
        <% end %>
      </div>
    <% end %>
   </div>
</div>
<% end %>
<% if @project.id.nil? %>
  <% @project.visible_custom_field_values.each do |value| %>
      <p><%= custom_field_tag_with_label :project, value %></p>
  <% end %>
<% else %>
  <% @project.visible_custom_field_values.each do |value| %>
    <% unless value.custom_field.name == "Revised End Date" %>
      <p><%= custom_field_tag_with_label :project, value %></p>
    <% end %>
  <% end %>
<% end %>
<%= call_hook(:view_projects_form, :project => @project, :form => f) %>
</div>

<% if @project.safe_attribute?('enabled_module_names') %>
<fieldset class="box tabular" id="project_modules"><legend><%= toggle_checkboxes_link('#project_modules input[type="checkbox"]') %><%= l(:label_module_plural) %></legend>
<% Redmine::AccessControl.available_project_modules.each do |m| %>
    <label class="floating">
    <%= check_box_tag 'project[enabled_module_names][]', m, @project.module_enabled?(m), :id => "project_enabled_module_names_#{m}" %>
    <%= l_or_humanize(m, :prefix => "project_module_") %>
    </label>
<% end %>
<%= hidden_field_tag 'project[enabled_module_names][]', '' %>
</fieldset>
<% end %>
<!--[eoform:project]-->

<% unless @project.identifier_frozen? %>
  <% content_for :header_tags do %>
    <%= javascript_include_tag 'project_identifier' %>
  <% end %>
<% end %>

<% if !User.current.admin? && @project.inherit_members? && @project.parent && User.current.member_of?(@project.parent) %>
  <%= javascript_tag do %>
    $(document).ready(function() {
      $("#project_inherit_members").change(function(){
        if (!$(this).is(':checked')) {
          if (!confirm("<%= escape_javascript(l(:text_own_membership_delete_confirmation)) %>")) {
            $("#project_inherit_members").attr("checked", true);
          }
        }
      });
    });
  <% end %>
<% end %>


<script>
 <% if !@project.id.nil? %>
  $(document).ready(function() {
    $('#update-revised-end-date').click(function() {
     
      var revisedEndDate = $('#revised_end_date').val();
      $.ajax({
        url: '<%= update_revised_end_date_project_path(@project) %>',
        method: 'POST',
        headers: {
          'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
        },
        data: { revised_end_date: revisedEndDate },
        success: function(response) {
          alert('Revised End Date updated successfully!');
          // You can redirect or perform any other action here after successful update
          location.reload();
        },
        error: function(xhr, status, error) {
          alert('Failed to update Revised End Date.');
          // Handle the error as needed
        }
      });
   
    });
  });
     <% end %>
</script>

